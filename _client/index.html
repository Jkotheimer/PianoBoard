<!DOCTYPE html>
<head>
	<meta charset="utf-8"/>
	<meta name="viewport" content="width=device-width, initial-scale=1"/>
	<title>PianoBoard Login</title>
	<link rel="icon" href="/images/favicon-32.png" type="image/png"/>
	<link href="https://fonts.googleapis.com/css?family=Kalam&display=swap" rel="stylesheet"/>
	<link href="https://fonts.googleapis.com/css?family=Exo&display=swap" rel="stylesheet"/>
	<link rel="stylesheet" href="/resources/css/variables.css"/>
	<link rel="stylesheet" href="login_page.css"/>
</head>
<body>
	<div class="panel">
		<div class="logo">
			<img src="/resources/images/logo.png"/>
		</div>

		<div class="link_area">
			<a href="./create_account" class="link ca_link">Create a new Account</a>
			<a href="./reset_password" class="link rp_link">Forgot password?</a>
			<div class="link s_link" onclick="login()">Sign In</div>
		</div>

		<div class="form_area">

			<div class="form_section">
				<div class="form_label">Email</div>
				<input type="text" id="email" class="form_input" placeholder="your.email@something.com"
					autocapitalize="off" spellcheck="false" autocorrect="off" required/>
				<div id="email_notification" class="notification"></div>
			</div>
			<div class="form_section">
				<div class="form_label">Password</div>
				<input type="password" id="password" class="form_input" placeholder="Enter your password" required/>
				<div id="password_notification" class="notification"></div>
			</div>
		</div>
	</div>

	<div class="info">
		Developed and maintained by Jack Kotheimer
		<br/>
		To learn more about me, visit my <a href="http://67.162.86.57">personal website</a>
	</div>

	<script type="text/javascript" src="/resources/js/resources.js"></script>
	<script>
		window.addEventListener('load', function(event) {
			if(localStorage.getItem(resources.token) != null) {
				validate_token(localStorage.getItem(resources.token));
			}
		});

		document.addEventListener("keydown", function() {
			if(event.keyCode == 13) {
				event.preventDefault();
				login();
			}
			else if(event.keyCode == 9 && document.activeElement.name == "password") {
				event.preventDefault();
				document.activeElement = document.getElementById("submit");
			}
		});

		function login() {
			var email = document.getElementById("email").value;
			var password = document.getElementById("password").value;
			var data = JSON.stringify({
				"email" : email,
				"password" : password
			});

			var xhr = new XMLHttpRequest();
			xhr.open("POST", resources.api_auth + "login", true);
			xhr.setRequestHeader("Content-Type", "application/json");
			xhr.onload = function() {
				if(xhr.status == 500) {
					// TODO display errors
					display_error("password", "There was a server error :/<br>Try again later.");
				} else if(xhr.status == 404) {
					display_error("email", "We couldn't find an account with this email try <a href='/create_account'>creating an account<a>");
				} else if(xhr.status == 401) {
					display_error("password", "Incorrect password");
				}
				else if(xhr.status == 201) {
					localStorage.setItem(resources.token, xhr.response);
					window.location.href = "/dashboard";
				}
			}
			xhr.send(data);
		}

		function validate_token(token) {
			var xhr = new XMLHttpRequest();
			xhr.open("POST", resources.api_auth + "token", true);
			xhr.setRequestHeader("Content-Type", "application/json");
			xhr.onload = function() {
				if(xhr.status == 201) {
					localStorage.setItem(resources.token, xhr.response);
					window.location.href = "/dashboard";
				}
				else {
					// Possibly add a GUI message to convey this?
					console.log(xhr.response);
				}
			}
			xhr.send(token);
		}
	</script>
</body>
